library(tidyverse)
library(sf)
library(tmap)
# library(plyr)

# Reading vectorial data  -------------------------------------------------

children <- read_sf('chlidren05.gpkg')
elderly <- read_sf('elderly60.gpkg')
health <- read_sf('HealthFacilities.gpkg')
transport <- read_sf('Transporte.gpkg')
water <- read_sf('water_index.gpkg')

layers <- list(children, elderly, health, transport, water)
# Normalization -----------------------------------------------------------
normalization <- function(x){
  index <- (x - min(x))/((max(x)- min(x)))
  return(index)
}

for(i in 1:length(layers)){
  data <- layers[[i]]
  data %>% 
    mutate(index = normalization(data[,10][[1]])) -> data_index
  
  write_sf(data_index,paste0('Normalization/',names_capas[i],'.gpkg'))
}


# Lectura de datos normalizados -----------------------
children <- read_sf('../vulnerability/Normalization/children.gpkg') %>% 
  as_tibble() %>% select(-geom)
elderly <- read_sf('../vulnerability/Normalization/elderly.gpkg') %>% 
  as_tibble() %>% select(-geom)
health <- read_sf('../vulnerability/Normalization/health.gpkg') %>% 
  as_tibble() %>% select(-geom)
transport <- read_sf('../vulnerability/Normalization/transport.gpkg') %>% 
  as_tibble() %>% select(-geom)
water <- read_sf('../vulnerability/Normalization/water.gpkg') %>% 
  as_tibble() %>% select(-geom)

level3 <- st_read('Levels_3.gpkg')
# Acciones para Salud ---------------------------------
# Vulnerabilidad = Po05 + Pob60 + Aces + Dhospitales

left_join(children,elderly, by='admin3Pcod') %>%
  left_join(.,transport, by='admin3Pcod') %>% 
  left_join(.,health, by='admin3Pcod') -> salud_acciones 

salud_acciones %>% 
  select(admin3Pcod,index.x,index.y,index.x.x,index.y.y) %>% 
  mutate(index_salud = index.x + index.y + index.x.x + index.y.y) %>% 
  select(admin3Pcod,index_salud) -> salud_acciones

salud_acciones <- left_join(level3,
                            salud_acciones,
                            by = 'admin3Pcod') 

# Acciones shelter ------------------------------------
# Vulnerabilidad = Po05 + Pob60 + Aces

left_join(children,elderly, by='admin3Pcod') %>%
  left_join(.,transport, by='admin3Pcod') -> shelter_acciones 

shelter_acciones %>% 
  select(admin3Pcod,index.x,index.y,index) %>% 
  mutate(index_shelter = index + index.y + index.x) %>% 
  select(admin3Pcod,index_shelter) -> shelter_acciones

shelter_acciones <- left_join(level3,
                            shelter_acciones,
                            by = 'admin3Pcod') 


# Acciones Wash ---------------------------------------
# Vulnerabilidad = Po05 + Pob60 + Fuentes_Agua + Acce

left_join(children,elderly, by='admin3Pcod') %>%
  left_join(.,transport, by='admin3Pcod') %>% 
  left_join(.,water, by='admin3Pcod') -> water_acciones 

water_acciones %>% 
  select(admin3Pcod,index.x,index.x.x,index.y,index.y.y) %>% 
  mutate(index_water = index.x + index.x.x + index.y + index.y.y) %>% 
  select(admin3Pcod,index_water) -> water_acciones

water_acciones <- left_join(level3,
                            water_acciones,
                            by = 'admin3Pcod') 


# Eliminacion de variables ----------------------------
rm(children)
rm(elderly)
rm(transport)
rm(water)
rm(health)
rm(level3)
rm(data)
rm(data_index)
rm(layers)
# Exportando data -------------------------------------------------------------------------------------------------

data_final <- list(salud_acciones,
                   shelter_acciones,
                   water_acciones)
names_final <- c("salud_acciones",
                 'shelter_acciones',
                 'water_acciones')

for(i in 1:length(data_final)){
  data <- data_final[[i]]
  write_sf(data,paste0('data_final/',names_final[i],'.gpkg'))
}

